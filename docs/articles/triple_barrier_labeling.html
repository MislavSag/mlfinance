<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>triple_barrier_labeling • mlfinance</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="triple_barrier_labeling">
<meta property="og:description" content="mlfinance">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mlfinance</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/triple_barrier_labeling.html">triple_barrier_labeling</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MislavSag/mlfinance/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="triple_barrier_labeling_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>triple_barrier_labeling</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MislavSag/mlfinance/blob/master/vignettes/triple_barrier_labeling.Rmd"><code>vignettes/triple_barrier_labeling.Rmd</code></a></small>
      <div class="hidden name"><code>triple_barrier_labeling.Rmd</code></div>

    </div>

    
    
<p>In these vignette we will show how to use triple barrier labelling in 2 cases:</p>
<ol style="list-style-type: decimal">
<li>Without primary model.</li>
<li>With primary model (meta labelling).</li>
</ol>
<p>First lets import packages and sample data from <code>mlfinance</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># import packages</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://Rdatatable.gitlab.io/data.table">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MislavSag/mlfinance">mlfinance</a></span><span class="op">)</span>

<span class="co"># import sample data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">spy</span><span class="op">)</span>
<span class="va">close</span> <span class="op">&lt;-</span> <span class="va">spy</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'index'</span>, <span class="st">'close'</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>Data contains SPY market data with 5 minute frequency for period from 2018-01-01 to 2020-01-01.</p>
<p>Next, we will calculate daily volatility. There are many options of how to calculate daily volatility from intraday data. Probably best approach would be to calculate realized volatility, but for our simple case we will <code>daily_volatility</code> function from the package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># compute daily volatility</span>
<span class="va">daily_vol</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/daily_volatility.html">daily_volatility</a></span><span class="op">(</span><span class="va">close</span>, <span class="fl">50</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">daily_vol</span><span class="op">)</span></code></pre></div>
<pre><code>##               Datetime        Value
## 1: 2018-01-03 15:39:00 0.0009618423
## 2: 2018-01-03 15:44:00 0.0010268916
## 3: 2018-01-03 15:49:00 0.0011668355
## 4: 2018-01-03 15:54:00 0.0012822868
## 5: 2018-01-03 15:59:00 0.0013209074
## 6: 2018-01-03 16:04:00 0.0013699927</code></pre>
<p>As you can see, the function returns daily volatility for every intraday timestamps. It does so by looking for nearest date from close index vector one day into the past.</p>
<p>Now, usually, we don’t want to trade on every (any) time period (bar), but want to filter important bars. We want to trade only when ‘something’ unusual happens on he market, because than there a re more inefficiencies (rationalities). One way to filter bars i to use CUSUM filter. Simply said, CUSUM filter check if return deviate more than some threshold in some period. We can calculate CUSUM events by following:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cusum_events</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cusum_filter.html">cusum_filter</a></span><span class="op">(</span><span class="va">close</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">daily_vol</span><span class="op">$</span><span class="va">Value</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cusum_events</span><span class="op">)</span></code></pre></div>
<pre><code>##               Datetime
## 1: 2018-01-02 21:59:00
## 2: 2018-01-03 18:39:00
## 3: 2018-01-04 15:34:00
## 4: 2018-01-05 17:19:00
## 5: 2018-01-08 19:09:00
## 6: 2018-01-09 19:24:00</code></pre>
<p>Next, we want to decide hoe long into the future we want to wait before we close out position. That is, we have to define vertical barrier:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vartical_barriers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_vertical_barrier.html">add_vertical_barrier</a></span><span class="op">(</span><span class="va">cusum_events</span>, <span class="va">close</span><span class="op">$</span><span class="va">index</span>, num_days <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">vartical_barriers</span><span class="op">)</span></code></pre></div>
<pre><code>##               Datetime                  t1
## 1: 2018-01-02 21:59:00 2018-01-03 21:59:00
## 2: 2018-01-03 18:39:00 2018-01-04 18:39:00
## 3: 2018-01-04 15:34:00 2018-01-05 15:34:00
## 4: 2018-01-05 17:19:00 2018-01-08 15:34:00
## 5: 2018-01-08 19:09:00 2018-01-09 19:09:00
## 6: 2018-01-09 19:24:00 2018-01-10 19:24:00</code></pre>
<p>Now we have everything we need to move to triple barrier method. We jump straight to code an dexplain all arguments:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">min_return</span> <span class="op">&lt;-</span> <span class="fl">0.005</span>
<span class="va">pt_sl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>
<span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_events.html">get_events</a></span><span class="op">(</span>price <span class="op">=</span> <span class="va">close</span>,                             <span class="co"># close data.table with index and value</span>
                     t_events <span class="op">=</span> <span class="va">cusum_events</span>,                   <span class="co"># bars to look at for trades</span>
                     pt_sl <span class="op">=</span> <span class="va">pt_sl</span>,                             <span class="co"># multiple target argument to get width of the barriers</span>
                     target <span class="op">=</span> <span class="va">daily_vol</span>,                        <span class="co"># values that are used to determine the width of the barrier</span>
                     min_ret <span class="op">=</span> <span class="va">min_return</span>,                      <span class="co"># minimum return between events</span>
                     vertical_barrier_times<span class="op">=</span><span class="va">vartical_barriers</span>,  <span class="co"># vartical barriers timestamps</span>
                     side_prediction<span class="op">=</span><span class="cn">NA</span><span class="op">)</span>                        <span class="co"># prediction from primary model (in this case no primary model)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">events</span><span class="op">)</span></code></pre></div>
<pre><code>##                     t0                  t1        trgt pt sl
## 1: 2018-01-30 16:09:00 2018-01-31 16:09:00 0.006064238  1  2
## 2: 2018-02-02 17:59:00 2018-02-05 15:34:00 0.005542836  1  2
## 3: 2018-02-02 19:44:00 2018-02-05 15:34:00 0.005750978  1  2
## 4: 2018-02-02 20:59:00 2018-02-05 15:34:00 0.005128506  1  2
## 5: 2018-02-05 15:34:00 2018-02-06 15:34:00 0.005760954  1  2
## 6: 2018-02-05 16:14:00 2018-02-06 16:14:00 0.008901707  1  2</code></pre>
<p>The resulting table shows:</p>
<ul>
<li>
<span class="math inline">\(t_0\)</span> - start date of the bar</li>
<li>
<span class="math inline">\(t_1\)</span> - end date of the bar</li>
<li>
<span class="math inline">\(trgt\)</span> - event’s target, threshold that has to be touched (after multiplying with <span class="math inline">\(pt\)</span> or <span class="math inline">\(st\)</span>)</li>
<li>
<span class="math inline">\(pt\)</span> - profit taking multiplier</li>
<li>
<span class="math inline">\(sl\)</span> - stop loss multiplier</li>
</ul>
<p>Finally, we have to generate bins (labels) based on events table and close prices:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_bins.html">get_bins</a></span><span class="op">(</span><span class="va">events</span>, <span class="va">close</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span></code></pre></div>
<pre><code>##               Datetime          ret        trgt bin
## 1: 2018-01-30 16:09:00  0.003800121 0.006064238   0
## 2: 2018-02-02 17:59:00 -0.015776612 0.005542836  -1
## 3: 2018-02-02 19:44:00 -0.013933895 0.005750978  -1
## 4: 2018-02-02 20:59:00 -0.009009987 0.005128506   0
## 5: 2018-02-05 15:34:00 -0.043706868 0.005760954  -1
## 6: 2018-02-05 16:14:00 -0.036141512 0.008901707  -1</code></pre>
<p>In the table we can see labels (bins) for dates extracted with CUSUM filter (you can choose your own filter). A a bonus, we get return column (<code>ret</code>) which can be used as weights in ML models.</p>
<p>Labels can be highly unbalanced which can be a problem for ML model. There is an <code>drop_labels</code> function in the package that deletes labels under some frequency threshold. Here is the example:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">labels_red</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/drop_labels.html">drop_labels</a></span><span class="op">(</span><span class="va">labels</span>, min_pct <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "dropped label: -1 0.140779220779221"</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">labels_red</span><span class="op">)</span></code></pre></div>
<pre><code>##               Datetime           ret        trgt bin
## 1: 2018-01-30 16:09:00  0.0038001208 0.006064238   0
## 2: 2018-02-02 20:59:00 -0.0090099870 0.005128506   0
## 3: 2018-02-05 21:04:00  0.0002242571 0.007565166   0
## 4: 2018-02-05 21:09:00  0.0164386668 0.009108594   1
## 5: 2018-02-05 21:14:00  0.0025474844 0.009527576   0
## 6: 2018-02-05 21:24:00 -0.0054372114 0.009741652   0</code></pre>
<p>The label -1 is deleted because it’s frequency (14%) is lower than threshold (20%).</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by The package maintainer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
